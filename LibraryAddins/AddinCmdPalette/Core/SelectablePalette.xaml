<UserControl x:Class="AddinCmdPalette.Core.SelectablePalette"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:AddinCmdPalette.Core"
             KeyDown="UserControl_KeyDown"
             PreviewKeyDown="UserControl_PreviewKeyDown"
             Loaded="UserControl_Loaded"
             VerticalAlignment="Top">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="WpfUiResources.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch">
        <!-- Popup for Tooltip -->
        <Popup x:Name="TooltipPopup"
               AllowsTransparency="True"
               PopupAnimation="Fade"
               StaysOpen="False">
            <local:SelectableTextBox x:Name="TooltipPanel"
                                     TooltipText="{Binding SelectedItem.TooltipText}"
                                     ReturnFocusTarget="{Binding ElementName=SearchTextBox}" />
        </Popup>

        <!-- Main container -->
        <Border Background="{DynamicResource BackgroundFillColorPrimaryBrush}"
                CornerRadius="8"
                BorderThickness="1"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Search Box -->
                <Border Grid.Row="0"
                        Background="{DynamicResource BackgroundFillColorPrimaryBrush}"
                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                        BorderThickness="0,0,0,1"
                        ClipToBounds="True"
                        CornerRadius="8,8,0,0">
                    <TextBox x:Name="SearchTextBox"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             PreviewKeyDown="SearchTextBox_PreviewKeyDown"
                             FontSize="{DynamicResource PaletteFontSizeMedium}"
                             FontFamily="Segoe UI Variable"
                             Padding="{DynamicResource PalettePaddingMedium}"
                             Margin="0"
                             Background="Transparent"
                             Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                             BorderThickness="0"
                             CaretBrush="{DynamicResource TextFillColorPrimaryBrush}">
                        <TextBox.InputBindings>
                            <KeyBinding Key="Down" Command="{Binding MoveSelectionDownCommand}" />
                            <KeyBinding Key="Up" Command="{Binding MoveSelectionUpCommand}" />
                        </TextBox.InputBindings>
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TextBox">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="0"
                                                    Padding="{TemplateBinding Padding}">
                                                <ScrollViewer x:Name="PART_ContentHost"
                                                              Margin="0"
                                                              Focusable="False" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                </Border>

                <!-- Item List -->
                <local:SelectableListBox x:Name="ItemListBox"
                                         Grid.Row="1"
                                         ItemsSource="{Binding FilteredItems}"
                                         SelectedItem="{Binding SelectedItem}"
                                         SelectedIndex="{Binding SelectedIndex}" />

                <!-- Status Bar -->
                <Border Grid.Row="2"
                        Background="{DynamicResource BackgroundFillColorPrimaryBrush}"
                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                        BorderThickness="0,1,0,0">
                    <Grid Margin="{DynamicResource PalettePaddingMedium}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="1"
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center">
                            <TextBlock Text="{Binding FilteredItems.Count, StringFormat=\{0\} items}"
                                       FontFamily="Segoe UI Variable"
                                       Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                       FontSize="{DynamicResource PaletteFontSizeNormal}"
                                       VerticalAlignment="Center"
                                       Margin="0,0,12,0" />
                            <TextBlock Text="↑↓ Navigate • ← Tooltip • → Actions • Click/Enter Execute • Esc Close"
                                       FontFamily="Segoe UI Variable"
                                       Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                       FontSize="{DynamicResource PaletteFontSizeNormal}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>